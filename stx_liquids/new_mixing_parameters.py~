import os, sys
sys.path.insert(1,os.path.abspath('..'))

import burnman
from burnman.minerals import \
    DKS_2013_liquids, \
    DKS_2013_solids, \
    SLB_2011
from burnman import constants
import numpy as np
from scipy.optimize import fsolve, curve_fit
import matplotlib.pyplot as plt
import matplotlib.image as mpimg


class MgO_SiO2_liquid(burnman.SolidSolution):
    def __init__(self, molar_fractions=None):
        self.name='Subregular MgO-SiO2 liquid'
        self.type='subregular'

        self.endmembers = [[DKS_2013_liquids.SiO2_liquid(), '[Mg]O'], 
                           [DKS_2013_liquids.MgO_liquid(), '[Si]O2']]

        self.enthalpy_interaction = [[[0., 0.]]]
        self.volume_interaction   = [[[0., 0.]]]
        self.entropy_interaction  = [[[0., 0.]]]
                        
        burnman.SolidSolution.__init__(self, molar_fractions)



liquid=MgO_SiO2_liquid()

class MgO_SiO2_liquid(burnman.SolidSolution):
    def __init__(self, molar_fractions=None):
        self.name='Subregular MgO-SiO2 liquid'
        self.type='subregular'

        self.endmembers = [[DKS_2013_liquids.MgO_liquid(), '[Mg]O'], 
                           [DKS_2013_liquids.SiO2_liquid(), '[Si]O2']]

        self.enthalpy_interaction = [[[0., 0.]]]
        self.volume_interaction   = [[[0., 0.]]]
        self.entropy_interaction  = [[[0., 0.]]]
                        
        burnman.SolidSolution.__init__(self, molar_fractions)



liquid=MgO_SiO2_liquid()


# SOLUTION MODEL CREATION
class MgO_MgSiO3_binary(burnman.SolidSolution):
    def __init__(self, molar_fractions=None):
        self.name='MgO-MgSiO3 liquid binary'
        self.type='full_subregular'
        self.n_atoms = 1.
        self.T_0 = 2000.
        self.P_0 = 1.e5
        self.endmembers = [[DKS_2013_liquids.MgO_liquid(),  '[Mg]O'],
                           [DKS_2013_liquids.MgSiO3_liquid(), 'Mg[Si]O3']]
        self.energy_interaction = [[[0., 0.]]]
        self.volume_interaction = [[[-1.e-6, -1.e-6]]]
        self.kprime_interaction = [[[7./3., 7./3.]]]
        self.thermal_pressure_interaction = [[[1.04, 1.04]]]
        burnman.SolidSolution.__init__(self, molar_fractions)

liq = MgO_MgSiO3_binary()

phases = [DKS_2013_liquids.MgSiO3_liquid(),
         DKS_2013_liquids.MgSi2O5_liquid(),
         DKS_2013_liquids.MgSi3O7_liquid(),
         DKS_2013_liquids.MgSi5O11_liquid(),
         DKS_2013_liquids.Mg2SiO4_liquid(),
         DKS_2013_liquids.Mg3Si2O7_liquid(),
         DKS_2013_liquids.Mg5SiO7_liquid()
         ]
phases = [DKS_2013_liquids.Mg2SiO4_liquid()]

# Set up endmembers
MgO_liq = DKS_2013_liquids.MgO_liquid()
MgSiO3_liq = DKS_2013_liquids.MgSiO3_liquid()
SiO2_liq = DKS_2013_liquids.SiO2_liquid()


temperatures = np.linspace(3000., 7000., 41)
Pth = np.empty_like(temperatures)
V_excesses = np.empty_like(temperatures)
phase = phases[0]
for P in np.linspace(1.e10, 10.e10, 10):
    for i, T in enumerate(temperatures):
        #P = phase.method.pressure(T, phase.params['V_0']*0.5, phase.params)
        #Pth[i] = P

        
        phase.set_state(P, T)
        MgO_liq.set_state(P, T)
        MgSiO3_liq.set_state(P, T)
        
        MgO_V = MgO_liq.V
        MgSiO3_V = MgSiO3_liq.V
        V_excesses[i] = phase.V - (MgSiO3_V + MgO_V)
        
        
    plt.plot(1./temperatures, V_excesses)
plt.xlim(0., 4e-4)
plt.show()

pressures = np.linspace(5.e9, 100.e9, 41)
temperatures = np.linspace(2000., 7000., 6)
V_excesses = np.empty_like(pressures)
V_excesses_model = np.empty_like(pressures)
a_excesses = np.empty_like(pressures)
aKT_excesses = np.empty_like(pressures)
for phase in phases:
    nSi = phase.params['formula']['Si']
    nMg = phase.params['formula']['Mg']
    
    sum_cations = nSi+nMg
    fSi=nSi/sum_cations
    for T in temperatures:
        for i, P in enumerate(pressures):

            print(P, T, fSi)
            MgO_liq.set_state(P, T)
            MgSiO3_liq.set_state(P, T)
            #SiO2_liq.set_state(P, T)
            
            phase.set_state(P, T)
            MgO_V = MgO_liq.V
            MgSiO3_V = MgSiO3_liq.V
            V_excesses[i] = phase.V - (MgSiO3_V + MgO_V)

            MgO_a = MgO_liq.alpha
            MgSiO3_a = MgSiO3_liq.alpha
            a_excesses[i] = (phase.alpha - (MgSiO3_a + MgO_a)/2.)/(phase.alpha)

            liq.set_composition([0.5, 0.5])
            liq.set_state(P, T)
            V_excesses_model[i] = liq.V - (MgSiO3_V + MgO_V)/2.
            
            MgO_aKT = MgO_liq.alpha*MgO_liq.K_T
            MgSiO3_aKT = MgSiO3_liq.alpha*MgSiO3_liq.K_T
            aKT_excesses[i] = (phase.alpha*phase.K_T - (MgSiO3_aKT + MgO_aKT)/2.)/(phase.alpha*phase.K_T)
         
        plt.subplot(221)   
        plt.plot(pressures, a_excesses, label=str(fSi)+': '+str(T)+' K')
        plt.subplot(222)   
        plt.plot(pressures, aKT_excesses, label=str(fSi)+': '+str(T)+' K')
        plt.subplot(223)   
        plt.plot(pressures, V_excesses, label=str(fSi)+': '+str(T)+' K')
        plt.subplot(224)   
        plt.plot(pressures, V_excesses_model, label=str(fSi)+': '+str(T)+' K (model)')

plt.legend(loc='lower right')
plt.show()

